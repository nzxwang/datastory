---
title: "R Notebook"
output: 
  html_document: 
    df_print: default
editor_options: 
  chunk_output_type: console
author: "Nick Wang"
---

```{r setup}
library(tidyverse)
library(tidytext)
library(KoNLP)
```

```{r import}
raw_pdf <- pdftools::pdf_text("/micehome/nwang/repos/datastory/misc/어린 왕자.pdf")

tlp <- raw_pdf %>%
  str_flatten() %>%
  str_split("      [\\d\\d|\\d]") %>%
  unlist() %>%
  .[-1] %>%
  str_replace_all("[a-zA-Z\\n]", "") %>%
  str_replace_all("^\\.", "") %>%
  str_trim(side="both")
```

```{r tokenize}
tlp <- tlp[1:3]

tokens <- tlp %>%
  paste0("Chapter", seq(length(.)), ., collapse="") %>%
  str_replace_all("“|”", "") %>%
  str_replace_all("\\.", "\\.Sentence_End") %>%
  str_split("Sentence_End") %>%
  unlist() %>%
  str_trim() %>%
  tibble(text=.) %>%
  mutate(
    chapter=cumsum(str_detect(text,"Chapter\\d")),
    sentence=row_number(),
    text=str_replace_all(text, "Chapter\\d", ""),
    pos09 = SimplePos09(text),
    word = map(pos09, function(pos09) {pos09 %>% names()})
         ) %>%
  unnest(pos09, word) %>%
  mutate(pos09 = str_split(pos09, "\\+")) %>%
  unnest(pos09) %>%
  select(-text) %>%
  mutate(tag = case_when(
    str_detect(pos09, "/N") ~ "nominal",
    str_detect(pos09, "/P") ~ "predicate",
    str_detect(pos09, "/M") ~ "modifier",
    str_detect(pos09, "/I") ~ "interjection",
    str_detect(pos09, "/J") ~ "relational suffix",
    str_detect(pos09, "/E") ~ "ending",
    str_detect(pos09, "/X") ~ "affix",
    str_detect(pos09, "/S") ~ "symbol",
    str_detect(pos09, "/F") ~ "foreign word"
  ),
  pos09 = str_replace(pos09, "/[NPMIJEXSF]", "")
  )
```


```{r}
tibble(text=tlp) %>%
  unnest_tokens(output=word, input=text) %>%
  count(word) %>%
  mutate(proportion = n / sum(n)) %>%
  arrange(desc(n))
```

